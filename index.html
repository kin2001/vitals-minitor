<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vitals Monitor</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #22d3ee;
      --accent-2: #a855f7;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --card: #1f2937;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.08), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(168,85,247,0.08), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    h1 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(34,211,238,0.15);
      color: var(--accent);
      font-weight: 600;
      font-size: 14px;
    }
    .status .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(34,211,238,0.8);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      align-items: start;
      grid-auto-rows: auto;
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .label {
      font-size: 14px;
      color: var(--muted);
    }
    .value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .sub {
      font-size: 13px;
      color: var(--muted);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }
    select, button {
      background: #0b1220;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 5px 7px;
      font-size: 14px;
      cursor: pointer;
      outline: none;
    }
    button.action {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none;
      color: #0b1220;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(34,211,238,0.2);
      padding: 6px 8px;
    }
    .controls select,
    .controls button {
      flex-shrink: 0;
    }
    .controls select {
      min-width: 72px;
      padding: 4px 7px;
      text-align-last: center;
    }
    .controls button.action {
      min-width: 0;
      padding: 5px 7px;
    }
    .history {
      background: #0b1220;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05);
      max-height: 220px;
      overflow: auto;
      display: none;
    }
    .history table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .history th, .history td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      text-align: left;
      color: var(--muted);
    }
    .history th {
      color: var(--text);
      position: sticky;
      top: 0;
      background: #0b1220;
      z-index: 1;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 640px) {
      body { padding: 16px; }
      .value { font-size: 28px; }
      .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .controls select,
      .controls button.action {
        width: 100%;
      }
    }
    @media (min-width: 641px) and (max-width: 1200px) {
      .controls {
        flex-wrap: wrap;
        row-gap: 8px;
      }
      .controls select,
      .controls button.action {
        width: calc(50% - 4px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Vitals Monitor</h1>
      <div class="label">Realtime health signals from your ESP32-C6</div>
    </div>
    <div class="status"><span class="dot"></span><span id="statusText">Live</span></div>
  </header>

  <div class="grid">
    <div class="card" data-type="bp">
      <div class="card-header">
        <div>
          <div class="label">Blood Pressure</div>
          <div class="value" id="bpValue">-- / --</div>
          <div class="sub" id="bpMeta">Waiting for data...</div>
        </div>
        <div class="controls">
          <select id="bpInterval">
            <option value="60000">1 min</option>
            <option value="300000">5 mins</option>
            <option value="600000">10 mins</option>
            <option value="1800000">30 mins</option>
            <option value="3600000">1 h</option>
            <option value="14400000">4 h</option>
          </select>
          <button class="action" data-history="bp">History</button>
        </div>
      </div>
      <div class="history" id="bpHistory"></div>
    </div>

    <div class="card" data-type="temp">
      <div class="card-header">
        <div>
          <div class="label">Temperature</div>
          <div class="value" id="tempValue">--.- °C</div>
          <div class="sub" id="tempMeta">Waiting for data...</div>
        </div>
        <div class="controls">
          <select id="tempInterval">
            <option value="60000">1 min</option>
            <option value="300000">5 mins</option>
            <option value="600000">10 mins</option>
            <option value="1800000">30 mins</option>
            <option value="3600000">1 h</option>
            <option value="14400000">4 h</option>
          </select>
          <button class="action" data-history="temp">History</button>
        </div>
      </div>
      <div class="history" id="tempHistory"></div>
    </div>

    <div class="card" data-type="hr">
      <div class="card-header">
        <div>
          <div class="label">Heart Rate</div>
          <div class="value" id="hrValue">-- BPM</div>
          <div class="sub" id="hrMeta">Waiting for data...</div>
        </div>
        <div class="controls">
          <select id="hrInterval">
            <option value="60000">1 min</option>
            <option value="300000">5 mins</option>
            <option value="600000">10 mins</option>
            <option value="1800000">30 mins</option>
            <option value="3600000">1 h</option>
            <option value="14400000">4 h</option>
          </select>
          <button class="action" data-history="hr">History</button>
        </div>
      </div>
      <div class="history" id="hrHistory"></div>
    </div>

    <div class="card" data-type="spo2">
      <div class="card-header">
        <div>
          <div class="label">SpO₂</div>
          <div class="value" id="spo2Value">-- %</div>
          <div class="sub" id="spo2Meta">Waiting for data...</div>
        </div>
        <div class="controls">
          <select id="spo2Interval">
            <option value="60000">1 min</option>
            <option value="300000">5 mins</option>
            <option value="600000">10 mins</option>
            <option value="1800000">30 mins</option>
            <option value="3600000">1 h</option>
            <option value="14400000">4 h</option>
          </select>
          <button class="action" data-history="spo2">History</button>
        </div>
      </div>
      <div class="history" id="spo2History"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Config: set your project URL and anon key ---
    const SUPABASE_URL = "https://vykswhovqjvyxbvxhgxo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5a3N3aG92cWp2eXhidnhoZ3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NDMwNzQsImV4cCI6MjA4MzUxOTA3NH0.iPgHsssKe4-sSBmfNls-APvtGXLZIgmZ1cf38BN7anY";
    const DEVICE_ID = "device-001";
    const TABLES = {
      bp: "bp_readings",
      temp: "temp_readings",
      hr: "hr_readings",
      spo2: "spo2_readings",
    };

    const state = {
      intervals: {},
      timers: {},
    };
    let configVersion = 0;
    let configLoaded = false;

    const headers = {
      "apikey": SUPABASE_KEY,
      "Authorization": "Bearer " + SUPABASE_KEY,
      "Content-Type": "application/json",
    };

    // Supabase client (also used for realtime)
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const realtimeClient = supa;

    function msToSeconds(ms) {
      return Math.round(ms / 1000);
    }

    function secondsToMs(sec) {
      return Number(sec) * 1000;
    }

    function formatTs(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    async function fetchLatest(type) {
      const table = TABLES[type];
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?device_id=eq.${DEVICE_ID}&order=ts.desc&limit=1`, { headers });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return data[0];
    }

    async function fetchHistory(type, limit = 20) {
      const table = TABLES[type];
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?device_id=eq.${DEVICE_ID}&order=ts.desc&limit=${limit}`, { headers });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function fetchDeviceConfig() {
      const { data, error } = await supa
        .from("device_config")
        .select("bp_interval_s,temp_interval_s,hr_interval_s,spo2_interval_s,config_version")
        .eq("device_id", DEVICE_ID)
        .limit(1);
      if (error) throw error;
      return data?.[0];
    }

    async function persistDeviceConfig() {
      const nextVersion = (configVersion ?? 0) + 1;
      const payload = {
        device_id: DEVICE_ID,
        bp_interval_s: msToSeconds(state.intervals.bp ?? Number(document.getElementById("bpInterval").value)),
        temp_interval_s: msToSeconds(state.intervals.temp ?? Number(document.getElementById("tempInterval").value)),
        hr_interval_s: msToSeconds(state.intervals.hr ?? Number(document.getElementById("hrInterval").value)),
        spo2_interval_s: msToSeconds(state.intervals.spo2 ?? Number(document.getElementById("spo2Interval").value)),
        config_version: nextVersion,
        updated_at: new Date().toISOString(),
      };
      try {
        const { data, error } = await supa
          .from("device_config")
          .update(payload)
          .eq("device_id", DEVICE_ID)
          .select();
        if (error) throw error;
        if (data && data.length) {
          configVersion = data[0]?.config_version ?? nextVersion;
          return;
        }
      } catch (e) {
        console.error("Failed to update device config via update", e);
      }
      try {
        const { data, error } = await supa
          .from("device_config")
          .upsert([payload], { onConflict: "device_id" })
          .select();
        if (error) throw error;
        configVersion = data?.[0]?.config_version ?? nextVersion;
      } catch (e) {
        console.error("Failed to upsert device config", e);
      }
    }

    function updateCard(type, row) {
      if (!row) return;
      if (type === "bp") {
        document.getElementById("bpValue").textContent = `${row.bp_sys ?? "--"} / ${row.bp_dia ?? "--"}`;
        document.getElementById("bpMeta").textContent = `HRbp: ${row.hr ?? row.hr_bpm ?? "--"} · ${formatTs(row.ts)}`;
      } else if (type === "temp") {
        document.getElementById("tempValue").textContent = `${row.temp_c ?? "--"} °C`;
        document.getElementById("tempMeta").textContent = formatTs(row.ts);
      } else if (type === "hr") {
        document.getElementById("hrValue").textContent = `${row.hr_bpm ?? "--"} BPM`;
        document.getElementById("hrMeta").textContent = formatTs(row.ts);
      } else if (type === "spo2") {
        document.getElementById("spo2Value").textContent = `${row.spo2 ?? "--"} %`;
        document.getElementById("spo2Meta").textContent = formatTs(row.ts);
      }
    }

    function renderHistory(type, rows) {
      const host = document.getElementById(`${type}History`);
      if (!rows || !rows.length) {
        host.innerHTML = "<div style='padding:10px;color:var(--muted);'>No data yet.</div>";
        return;
      }
      const headersRow = {
        bp: ["Timestamp", "SYS", "DIA"],
        temp: ["Timestamp", "Temp (°C)"],
        hr: ["Timestamp", "HR (BPM)"],
        spo2: ["Timestamp", "SpO₂ (%)"],
      }[type];
      let html = "<table><thead><tr>";
      headersRow.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";
      rows.forEach(r => {
        html += "<tr>";
        if (type === "bp") {
          html += `<td>${formatTs(r.ts)}</td><td>${r.bp_sys ?? ""}</td><td>${r.bp_dia ?? ""}</td>`;
        } else if (type === "temp") {
          html += `<td>${formatTs(r.ts)}</td><td>${r.temp_c ?? ""}</td>`;
        } else if (type === "hr") {
          html += `<td>${formatTs(r.ts)}</td><td>${r.hr_bpm ?? ""}</td>`;
        } else if (type === "spo2") {
          html += `<td>${formatTs(r.ts)}</td><td>${r.spo2 ?? ""}</td>`;
        }
        html += "</tr>";
      });
      html += "</tbody></table>";
      host.innerHTML = html;
    }

    async function refresh(type, withHistory = false) {
      try {
        const row = await fetchLatest(type);
        if (row) updateCard(type, row);
        if (withHistory) {
          const hist = await fetchHistory(type);
          renderHistory(type, hist);
        }
        document.getElementById("statusText").textContent = "Live";
      } catch (e) {
        console.error(e);
        document.getElementById("statusText").textContent = "Error";
      }
    }

    function schedule(type, ms) {
      if (state.timers[type]) clearInterval(state.timers[type]);
      state.timers[type] = setInterval(() => refresh(type, false), ms);
      state.intervals[type] = ms;
    }

    function applyIntervalFromSelect(type) {
      const select = document.getElementById(`${type}Interval`);
      schedule(type, Number(select.value));
    }

    async function handleIntervalChange(type) {
      applyIntervalFromSelect(type);
      await persistDeviceConfig();
    }

    function setupIntervals() {
      ["bp","temp","hr","spo2"].forEach(type => {
        const select = document.getElementById(`${type}Interval`);
        select.addEventListener("change", () => {
          handleIntervalChange(type);
        });
      });
    }

    async function loadDeviceConfig() {
      try {
        const cfg = await fetchDeviceConfig();
        if (cfg) {
          configVersion = cfg.config_version ?? 0;
          const map = {
            bp: cfg.bp_interval_s,
            temp: cfg.temp_interval_s,
            hr: cfg.hr_interval_s,
            spo2: cfg.spo2_interval_s,
          };
          ["bp","temp","hr","spo2"].forEach(type => {
            const select = document.getElementById(`${type}Interval`);
            const fromDb = Number(map[type]);
            const ms = Number.isFinite(fromDb) ? secondsToMs(fromDb) : Number(select.value);
            select.value = String(ms);
            schedule(type, ms);
          });
          configLoaded = true;
          return;
        }
      } catch (e) {
        console.error("Failed to load device config", e);
      }
      ["bp","temp","hr","spo2"].forEach(applyIntervalFromSelect);
    }

    function setupHistoryButtons() {
      document.querySelectorAll("button[data-history]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const type = btn.getAttribute("data-history");
          const panel = document.getElementById(`${type}History`);
          const showing = panel.style.display === "block";
          if (!showing) {
            await refresh(type, true);
            panel.style.display = "block";
          } else {
            panel.style.display = "none";
          }
        });
      });
    }

    function setupRealtime() {
      ["bp","temp","hr","spo2"].forEach(type => {
        realtimeClient
          .channel(`realtime:${type}`)
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: TABLES[type],
              filter: `device_id=eq.${DEVICE_ID}`,
            },
            payload => {
              const row = payload.new;
              updateCard(type, row);
              const panel = document.getElementById(`${type}History`);
              if (panel.style.display === "block") {
                refresh(type, true);
              }
              document.getElementById("statusText").textContent = "Live";
            }
          )
          .subscribe(status => {
            if (status === "SUBSCRIBED") {
              document.getElementById("statusText").textContent = "Live";
            }
          });
      });
    }

    function setupGlobalHeartbeat() {
      // Fallback: refresh all cards every 10s in case realtime is unavailable.
      setInterval(() => {
        ["bp","temp","hr","spo2"].forEach(t => refresh(t, false));
      }, 10000);
    }

    // Init
    (async function() {
      await loadDeviceConfig();
      setupIntervals();
      setupHistoryButtons();
      await Promise.all(["bp","temp","hr","spo2"].map(t => refresh(t, false)));
      setupRealtime();
      setupGlobalHeartbeat();
    })();
  </script>
</body>
</html>
